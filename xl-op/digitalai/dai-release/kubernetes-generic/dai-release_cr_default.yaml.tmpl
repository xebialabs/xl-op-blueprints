apiVersion: xlr.digital.ai/v1alpha1
kind: DigitalaiRelease
metadata:
  {{- if eq .K8sSetup "Openshift" }}
  {{- if eq .UseCustomNamespace true }}
  name: dai-ocp-xlr-{{ .Namespace }}
  {{- else }}
  name: dai-ocp-xlr
  {{- end }}
  {{- else }}
  {{- if eq .UseCustomNamespace true }}
  name: dai-xlr-{{ .Namespace }}
  {{- else }}
  name: dai-xlr
  {{- end }}
  {{- end }}
spec:
  global:
    {{- if eq .IsCustomImageRegistry true }}
    imageRegistry: {{ .CustomImageRegistryName }}
    {{- end }}
    {{- if eq .ImageRegistryType "private" }}
    imagePullSecrets:
      - {{ .CustomPrivateImageRegistrySecret }}
    {{- end }}
    storageClass: "{{ .StorageClass }}"
  k8sSetup:
    platform: {{ .K8sSetup }}
  auth:
    adminPassword: "{{ .AdminPassword }}"
  {{- if eq .LicenseSource "generate" }}
  licenseAcceptEula: true
  {{- else }}
  license: |-
{{ .License | trim | indent 4 }}
  {{- end }}
  keystore:
    passphrase: "{{ .KeystorePassphrase }}"
    keystore: |- 
{{ .RepositoryKeystore | trim | indent 6 }}
  replicaCount: {{ .XlrReplicaCount }}
  external:
    db:
      {{- if eq .EnablePostgresql false }}
      enabled: true
{{ .PostgresqlExternalConfigRelease | indent 6 }}
      {{- else }}
      enabled: false
      {{- end }}
    mq:
      {{- if eq .EnableRabbitmq false }}
      enabled: true
{{ .RabbitmqExternalConfigRelease | indent 6 }}
      {{- else }}
      enabled: false
      {{- end }}
  oidc:
    enabled: {{ not (eq .OidcConfigType "no-oidc") }}
{{ .ExternalOidcConf | indent 4 }}
  http2:
    enabled: {{ .Http2EnabledRelease }}
  ssl:
    enabled: {{ .Http2EnabledRelease }}
    keystorePassword: {{ .ReleaseKeystorePassword }}
    keystoreKeypassword: {{ .ReleaseKeystoreKeyPassword }}
    {{- if eq .ReleaseKeystoreSource "secret" }}
    keystore:
      valueFrom:
        secretKeyRef:
          name: {{ .ReleaseKeystoreSecretName }}
          key: ssl-keystore.p12
    {{- else }}
    keystore: |-
{{ .ReleaseKeystore | indent 6 }}
    {{- end }}
  persistence:
    accessModes:
      - {{ .AccessModeRelease }}
    size: {{ .PvcSizeRelease }}Gi
  image:
    repository: {{ .RepositoryName }}/{{ .ImageNameRelease }}
    tag: "{{ .ImageTag }}"
  {{- if eq .IsCustomImageRegistry true }}
  busyBox:
    image:
      registry: {{ .CustomImageRegistryName }}
      repository: {{ .RepositoryName }}/busybox
  {{- end }}
  diagnosticMode:
    enabled: false
  ingress:
    {{- if eq .IngressType "nginx" }}
    enabled: true
    annotations:
      {{- if eq .UseCustomNamespace true }}
      kubernetes.io/ingress.class: nginx-dai-xlr-{{ .Namespace }}
      {{- else }}
      kubernetes.io/ingress.class: nginx-dai-xlr
      {{- end }}
      nginx.ingress.kubernetes.io/affinity: cookie
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "120"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
      nginx.ingress.kubernetes.io/rewrite-target: /
      nginx.ingress.kubernetes.io/session-cookie-name: ROUTE
      nginx.ingress.kubernetes.io/ssl-redirect: "{{ .EnableIngressTls }}"
    {{- end }}
    {{- if eq .IngressType "haproxy" }}
    enabled: true
    annotations:
      {{- if eq .UseCustomNamespace true }}
      kubernetes.io/ingress.class: haproxy-dai-xlr-{{ .Namespace }}
      {{- else }}
      kubernetes.io/ingress.class: haproxy-dai-xlr
      {{- end }}
      ingress.kubernetes.io/rewrite-target: /
      ingress.kubernetes.io/affinity: cookie
      ingress.kubernetes.io/session-cookie-name: JSESSIONID
      ingress.kubernetes.io/session-cookie-strategy: prefix
      ingress.kubernetes.io/timeout-client: "120s"
      ingress.kubernetes.io/timeout-http-request: "120s"
      ingress.kubernetes.io/config-backend: |
        option httpchk GET /ha/health HTTP/1.0
      ingress.kubernetes.io/ssl-redirect: "{{ .EnableIngressTls }}"
    {{- end }}
    {{- if eq .IngressType "external" }}
    enabled: true
    annotations:
      kubernetes.io/ingress.class: {{ .ExternalIngressClass }}
      ingress.kubernetes.io/rewrite-target: /
      ingress.kubernetes.io/affinity: cookie
      ingress.kubernetes.io/session-cookie-name: JSESSIONID
      ingress.kubernetes.io/session-cookie-strategy: prefix
      ingress.kubernetes.io/timeout-client: "120s"
      ingress.kubernetes.io/timeout-http-request: "120s"
      ingress.kubernetes.io/config-backend: |
        option httpchk GET /ha/health HTTP/1.0
      ingress.kubernetes.io/ssl-redirect: "{{ .EnableIngressTls }}"
    {{- end }}
    {{- if eq .IngressType "none" }}
    enabled: false
    {{- end }}
    hostname: "{{ .IngressHost }}"
    path: /
    {{- if eq .EnableIngressTls true }}
    # If you want to use TLS configuration uncomment the following lines and provide correct values.
    # You need to create secret, and provide the name under "secretName"
    tls: true
    extraTls:
      - hosts:
          - "{{ .IngressHost }}"
        secretName: "{{ .IngressTlsSecretName }}"
    {{- end }}
  route:
    {{- if eq .IngressType "route" }}
    enabled: true
    annotations:
      haproxy.router.openshift.io/cookie_name: JSESSIONID
      haproxy.router.openshift.io/disable_cookies: "false"
      haproxy.router.openshift.io/rewrite-target: /
      haproxy.router.openshift.io/timeout: 120s
    hostname: "{{ .IngressHost }}"
    path: /
    {{- else }}
    enabled: false
    {{- end }}
  haproxy-ingress:
    controller:
      {{- if eq .IsCustomImageRegistry true }}
      image:
        repository: {{ .CustomImageRegistryName }}/{{ .RepositoryName }}/haproxy-ingress
      {{- end }}
      {{- if eq .ImageRegistryType "private" }}
      imagePullSecrets:
      - name: {{ .CustomPrivateImageRegistrySecret }}
      {{- end }}
      {{- if eq .UseCustomNamespace true }}
      ingressClass: haproxy-dai-xlr-{{ .Namespace }}
      {{- else }}
      ingressClass: haproxy-dai-xlr
      {{- end }}
    {{- if eq .IngressType "haproxy" }}
    install: true
    {{- else }}
    install: false
    {{- end }}
  nginx-ingress-controller:
    {{- if eq .IsCustomImageRegistry true }}
    defaultBackend:
      image:
        {{- /* registry name defined in global section */}}
        repository: {{ .RepositoryName }}/nginx
    {{- end }}
    {{- if eq .UseCustomNamespace true }}
    extraArgs:
      ingress-class: "nginx-dai-xlr-{{ .Namespace }}"
    {{- else }}
    extraArgs:
      ingress-class: nginx-dai-xlr
    {{- end }}
    {{- if (eq .IsCustomImageRegistry true) }}
    global:
      {{- /* global overrides the other occurences */}}
      imageRegistry: {{ .CustomImageRegistryName }}
      {{- if eq .ImageRegistryType "private" }}
      imagePullSecrets: [ {{ .CustomPrivateImageRegistrySecret }} ]
      {{- end }}
    {{- end }}
    {{- if eq .IsCustomImageRegistry true }}
    image:
      {{- /* registry name defined in global section */}}
      repository: {{ .RepositoryName }}/nginx-ingress-controller
    {{- end }}
    {{- if eq .UseCustomNamespace true }}
    ingressClassResource:
      controllerClass: k8s.io/ingress-nginx-dai-xlr-{{ .Namespace }}
      name: nginx-dai-xlr-{{ .Namespace }}
    {{- else }}
    ingressClassResource:
      controllerClass: k8s.io/ingress-nginx-dai-xlr
      name: nginx-dai-xlr
    {{- end }}
    {{- if eq .IngressType "nginx" }}
    install: true
    {{- else }}
    install: false
    {{- end }}
  postgresql:
    global:
      {{- /*  global overrides the other occurences */}}
      {{- if eq .IsCustomImageRegistry true }}
      imageRegistry: {{ .CustomImageRegistryName }}
      {{- end }}
      {{- if eq .ImageRegistryType "private" }}
      imagePullSecrets:
        - {{ .CustomPrivateImageRegistrySecret }}
      {{- end }}
      storageClass: "{{ .PostgresqlStorageClass }}"
    {{- if eq .IsCustomImageRegistry true }}
    image:
      {{- /* registry name defined in global section */}}
      repository: {{ .RepositoryName }}/postgresql
    {{- end }}
    install: {{ .EnablePostgresql }}
    primary:
      persistence:
        size: {{ .PostgresqlPvcSize }}Gi
    securityContext:
      enabled: true
      fsGroup: 1001
    {{- if eq .IsCustomImageRegistry true }}
    volumePermissions:
      image:
        {{- /* registry name defined in global section */}}
        repository: {{ .RepositoryName }}/os-shell
    {{- end }}    
  rabbitmq:
    {{- if eq .IsCustomImageRegistry true }}
    global:
      {{- /* global overrides the other occurences */}}
      imageRegistry: {{ .CustomImageRegistryName }}
      {{- if eq .ImageRegistryType "private" }}
      imagePullSecrets:
      - {{ .CustomPrivateImageRegistrySecret }}
      {{- end }}
    {{- end }}
    {{- if eq .IsCustomImageRegistry true }}
    image:
      {{- /* registry name defined in global section */}}
      repository: {{ .RepositoryName }}/rabbitmq
    {{- end }}
    install: {{ .EnableRabbitmq }}
    persistence:
      size: {{ .RabbitmqPvcSize }}Gi
      storageClass: "{{ .RabbitmqStorageClass }}"
    replicaCount: {{ .RabbitmqReplicaCount }}
    volumePermissions:
      enabled: true
      {{- if eq .IsCustomImageRegistry true }}
      image:
        {{- /* registry name defined in global section */}}
        repository: {{ .RepositoryName }}/bitnami-shell
      {{- end }}
    securityContext:
      enabled: true
      fsGroup: 1001
    podSecurityContext:
      enabled: true
      fsGroup: 1001
      runAsUser: 1001
