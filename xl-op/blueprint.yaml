apiVersion: xl/v2
kind: Blueprint
metadata:
  name: XL OP
  description: |
    This blueprint deploys DAI Deploy operator, DAI Release operator, and XL-k8s-foundation into an existing Kubernetes installation (local single-node Kubernetes, on-premises multi-node Kubernetes cluster, or Amazon EKS cluster).
  author: Digital.ai
  version: 1.0
spec:
  parameters:
    - name: RepositoryName
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the repository name (eg: <repositoryName> from <repositoryName>/<imageName>:<tagName>):"
      default: xebialabsunsupported
      description: Enter the repository name to use
    - name: ImageNameDeploy
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr ServerType == 'dai-deploy'
      prompt: "Enter the deploy server image name (eg: <imageName> from <repositoryName>/<imageName>:<tagName>):"
      default: xl-deploy
      description: Enter the deploy server image name to use
    - name: ImageNameRelease
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr ServerType == 'dai-release'
      prompt: "Enter the image name (eg: <imageName> from <repositoryName>/<imageName>:<tagName>):"
      default: xl-release
      description: Enter the image name to use
    - name: ImageTag
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the image tag (eg: <tagName> from <repositoryName>/<imageName>:<tagName>):"
      default: 22.3.0-628.113
      description: Enter the image tag to use
    - name: ImageNameDeployTaskEngine
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr "ServerType == 'dai-deploy' && !regex('^10.*$', ImageTag)"
      prompt: "Enter the deploy task engine image name for version 22 and above (eg: <imageName> from <repositoryName>/<imageName>:<tagName>):"
      default: deploy-task-engine
      description: Enter the deploy task engine image name to use
    - name: XldMasterCount
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr "ServerType == 'dai-deploy' && ProcessType == 'install'"
      prompt: "Enter the deploy master server replica count:"
      default: 3
      description: Enter the deploy master server replica count
      validate: !expr "regex('^([0-9])+$', XldMasterCount)"
    - name: XldWorkerCount
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr "ServerType == 'dai-deploy' && ProcessType == 'install'"
      prompt: "Enter the deploy worker replica count:"
      default: 3
      description: Enter the deploy worker replica count
      validate: !expr "regex('^([0-9])+$', XldWorkerCount)"
    - name: XlrReplicaCount
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr "ServerType == 'dai-release' && ProcessType == 'install'"
      prompt: "Enter the release server replica count:"
      default: 3
      description: Enter the release server replica count
      validate: !expr "regex('^([0-9])+$', XlrReplicaCount)"
    - name: IngressType
      type: Select
      prompt: "Select between supported ingress types:"
      options:
        - label: NGINX
          value: nginx
        - label: HAProxy
          value: haproxy
        - label: External
          value: external
        - label: None
          value: none
      promptIf: !expr ProcessType == "install"
      saveInXlvals: true
      default: !expr "K8sSetup == 'PlainK8s' ? 'none' : 'nginx'"
      description: Select between supported ingress types?
    - name: ExternalIngressClass
      type: Select
      options:
        - !expr k8sResources(Namespace, 'ingressclasses')
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide external ingress class:"
      promptIf: !expr ProcessType == "install" && IngressType == "external"
      description: External ingress class
    - name: EnableIngressTls
      type: Confirm
      default: false
      saveInXlvals: true
      ignoreIfSkipped: false
      overrideDefault: true
      prompt: "Do you want to enable an TLS/SSL configuration:"
      promptIf: !expr ProcessType == "install" && IngressType != "none"
      description: "Enable TLS/SSL in the Ingress configuration."
    - name: IngressHost
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide DNS name for accessing UI of the server:"
      promptIf: !expr ProcessType == "install" && IngressType != "none"
      description: Provide DNS name for accessing UI of the server
      validate: !expr "regex('^[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-z]{2,6}$', IngressHost)" 
    - name: IngressTlsSecretName
      type: Select
      options:
        - !expr k8sResources(Namespace, 'secrets')
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide DNS name for accessing UI of the server:"
      promptIf: !expr EnableIngressTls && ProcessType == "install" && IngressType != "none"
      description: Provide the TLS secret name with the key and certificate
    - name: AdminPassword
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide administrator password:"
      promptIf: !expr ProcessType == "install"
      description: Administrator password
      default: !expr "randPassword()"
    - name: OidcConfigTypeInstall
      type: Select
      options:
        - label: External OIDC Configuration
          value: external
        - label: Embedded Keycloack Configuration
          value: embedded
        - label: No OIDC Configuration
          value: no-oidc
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Type of the OIDC configuration:"
      promptIf: !expr ProcessType == "install"
      description: Provide the type of the OIDC configuration
    - name: OidcConfigTypeUpgrade
      type: Select
      options:
        - label: Existing OIDC Configuration
          value: existing
        - label: External OIDC Configuration
          value: external
        - label: Embedded Keycloack Configuration
          value: embedded
        - label: No OIDC Configuration
          value: no-oidc
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Type of the OIDC configuration:"
      promptIf: !expr ProcessType == "upgrade"
      description: Provide the type of the OIDC configuration
    - name: OidcConfigType
      type: Input
      saveInXlvals: true
      value: !expr "ProcessType == 'install' ? OidcConfigTypeInstall : OidcConfigTypeUpgrade"
      description: The type of the OIDC configuration
    - name: UseKeycloakWithEmbeddedDB
      type: Confirm
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr OidcConfigType == 'embedded'
      prompt: "Use embedded DB for keycloak:"
      default: !expr OidcConfigTypeUpgrade == 'embedded'
      description: "If true, keycloak will be installed in kubernetes cluster with embedded DB. If false, we need to use the custom zip options and update cr yaml file with external DB for keycloak"
    - name: KeycloakHost
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      promptIf: !expr OidcConfigType == 'embedded'
      prompt: "Enter Keycloak public URL:"
      description: Enter Keycloak public URL that will be used for keycloak installation.
      validate: !expr "regex('^[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-z]{2,6}$', KeycloakHost)" 
    - name: ExternalOidcConf
      type: Editor
      prompt: "Configure external oidc setup:"
      promptIf: !expr OidcConfigType == 'external'
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      default: |-
        external: true
        accessTokenUri: null
        clientId: null
        clientSecret: null
        emailClaim: null
        fullNameClaim: null
        issuer: null
        keyRetrievalUri: null
        logoutUri: null
        postLogoutRedirectUri: null
        redirectUri: null
        rolesClaim: null
        userAuthorizationUri: null
        userNameClaim: null
        scopes: '["openid"]'
    - name: UpgradeType
      type: Select
      prompt: "Select the type of upgrade you want:"
      ignoreIfSkipped: true
      options:
        - label: Operator to Operator
          value: operatorToOperator
        - label: Helm to Operator
          value: helmToOperator
      promptIf: !expr ProcessType == "upgrade"
      saveInXlvals: true
      description: Type of upgrade you want?
    - name: OperatorImageDeployGeneric
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the operator image to use (eg: <repositoryName>/<imageName>:<tagName>)"
      promptIf: !expr ServerType == 'daiDeploy' && K8sSetup != 'Openshift'
      default: xebialabsunsupported/deploy-operator:22.3.0-808.113
      description: Enter the operator image to use
    - name: OperatorImageDeployOpenshift
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the operator image to use (eg: <repositoryName>/<imageName>:<tagName>)"
      promptIf: !expr ServerType == 'daiDeploy' && K8sSetup == 'Openshift'
      default: xebialabsunsupported/deploy-operator:22.3.0-808.113-openshift
      description: Enter the operator image to use
    - name: OperatorImageReleaseGeneric
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the operator image to use (eg: <repositoryName>/<imageName>:<tagName>)"
      promptIf: !expr ServerType == 'daiRelease' && K8sSetup != 'Openshift'
      default: xebialabsunsupported/release-operator:22.3.0-808.113
      description: Enter the operator image to use
    - name: OperatorImageReleaseOpenshift
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Enter the operator image to use (eg: <repositoryName>/<imageName>:<tagName>)"
      promptIf: !expr ServerType == 'daiRelease' && K8sSetup == 'Openshift'
      default: xebialabsunsupported/release-operator:22.3.0-808.113-openshift
      description: Enter the operator image to use
    - name: LicenseSource
      type: Select
      options:
        - label: File
          value: file
        - label: Copy/Paste the license to editor
          value: editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Select source of the licenase:"
      promptIf: !expr ProcessType == "install"
      description: "Provide source of the license file"
      default: file
    - name: LicenseEditor
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      prompt: "Provide license for the server:"
      promptIf: !expr ProcessType == "install" && LicenseSource == "editor"
      description: "Provide license file for the server"
      default: ""
    - name: LicenseFile
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide license file for the server:"
      promptIf: !expr ProcessType == "install" && LicenseSource == "file"
      description: "Provide license file for the server"      
      validate: !expr "isFile(LicenseFile)"
      default: ""
    - name: License
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      description: Provide license file for the server
      value: !expr "LicenseSource == 'editor' ? ifBase64(LicenseEditor) : ifBase64(ifFileReadBytes(LicenseFile))"
    - name: RepositoryKeystoreSource
      type: Select
      options:
        - label: File
          value: file
        - label: Copy/Paste the repositry keystore to editor
          value: editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Select source of the repository keystore:"
      promptIf: !expr ProcessType == "install"
      description: "Provide source of the license file"
      default: file
    - name: RepositoryKeystoreEditor
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide repository keystore for the server:"
      promptIf: !expr "ProcessType == 'install' && RepositoryKeystoreSource == 'editor'"
      description: "Provide repository keystore for the server, generated with: `keytool -genseckey -alias deployit-passsword-key -keyalg aes -keysize 128 -keypass deployit -keystore repository-keystore.jceks -storetype jceks -storepass <KeystorePassphrase>`"
      default: ""
    - name: RepositoryKeystoreFile
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide repository keystore for the server:"
      promptIf: !expr "ProcessType == 'install' && RepositoryKeystoreSource == 'file'"
      description: "Provide repository keystore for the server, generated with: `keytool -genseckey -alias deployit-passsword-key -keyalg aes -keysize 128 -keypass deployit -keystore repository-keystore.jceks -storetype jceks -storepass <KeystorePassphrase>`"
      validate: !expr "isFile(RepositoryKeystoreFile)"
      default: ""      
    - name: RepositoryKeystore
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      description: Provide repository keystore for the server
      value: !expr "RepositoryKeystoreSource == 'editor' ? ifBase64(RepositoryKeystoreEditor) : ifBase64(ifFileReadBytes(RepositoryKeystoreFile))"
    - name: KeystorePassphrase
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide keystore passphrase:"
      promptIf: !expr ProcessType == "install"
      description: Keystore passphrase for the server
    - name: StorageClass
      type: Select
      options:
        - !expr k8sResources(Namespace, 'storageclasses')
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide storage class for the server:"
      promptIf: !expr ProcessType == "install"
      description: Provide storage class for the server
    - name: EnablePostgresql
      type: Confirm
      default: true
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Do you want to enable an PostgreSQL:"
      promptIf: !expr ProcessType == "install"
      description: "Enable PostgreSQL."
    - name: PostgresqlStorageClass
      type: Select
      options:
        - !expr k8sResources(Namespace, 'storageclasses')
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Provide Storage Class to be defined for PostgreSQL:"
      default: !expr StorageClass
      promptIf: !expr ProcessType == "install" && EnablePostgresql
      description: Provide Storage Class to be defined for PostgreSQL
    - name: PostgresqlExternalConfigRelease
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Edit PostgreSQL external setup:"
      promptIf: !expr "ServerType == 'dai-release' && ProcessType == 'install' && EnablePostgresql == false"
      description: Setup the PostgreSQL external parameters
      default: |-
        XLR_DB_URL: jdbc:postgresql://<xlr-db-host>:5432/<xlr-database-name>
        XLR_DB_USER: <xlr-username>
        XLR_DB_PASS: <xlr-password>
        XLR_REPORT_DB_URL: jdbc:postgresql://<xlr-report-db-host>:5432/<xl-report-database-name>
        XLR_REPORT_DB_USER: <xl-report-username>
        XLR_REPORT_DB_PASS: <xl-report-password>
    - name: PostgresqlExternalConfigDeploy
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Edit PostgreSQL external setup:"
      promptIf: !expr "ServerType == 'dai-deploy' && ProcessType == 'install' && EnablePostgresql == false"
      description: Setup the PostgreSQL external parameters
      default: |-
        XL_DB_URL: jdbc:postgresql://<xld-db-host>:5432/<xlr-database-name>
        XL_DB_USERNAME: <xld-username>
        XL_DB_PASSWORD: <xld-password>
    - name: EnableRabbitmq
      type: Confirm
      default: true
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Do you want to enable an RabbitMQ:"
      promptIf: !expr ProcessType == "install"
      description: "Enable RabbitMQ."
    - name: RabbitmqReplicaCount
      type: Input
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Replica count to be defined for RabbitMQ:"
      default: 3
      promptIf: !expr "ProcessType == 'install' && EnableRabbitmq"
      description: Replica count to be defined for RabbitMQ
      validate: !expr "regex('^([0-9])+$', RabbitmqReplicaCount)"
    - name: RabbitmqStorageClass
      type: Select
      options:
        - !expr k8sResources(Namespace, 'storageclasses')
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Storage Class to be defined for RabbitMQ:"
      default: !expr StorageClass
      promptIf: !expr "ProcessType == 'install' && EnableRabbitmq"
      description: Storage Class to be defined for RabbitMQ
    - name: RabbitmqExternalConfigRelease
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Edit RabbitMQ external setup:"
      promptIf: !expr "ServerType == 'dai-release' && ProcessType == 'install' && EnableRabbitmq == false"
      description: Setup the RabbitMQ external parameters
      default: |-
        XLR_TASK_QUEUE_USERNAME: <username>
        XLR_TASK_QUEUE_PASSWORD: <password>
        XLR_TASK_QUEUE_NAME: <queue-name>
        XLR_TASK_QUEUE_URL: <queue-url>
    - name: RabbitmqExternalConfigDeploy
      type: Editor
      saveInXlvals: true
      ignoreIfSkipped: true
      overrideDefault: true
      prompt: "Edit RabbitMQ external setup:"
      promptIf: !expr "ServerType == 'dai-deploy' && ProcessType == 'install' && EnableRabbitmq == false"
      description: Setup the RabbitMQ external parameters
      default: |-
        XLD_TASK_QUEUE_DRIVER_CLASS_NAME: <driver-class-name>
        XLD_TASK_QUEUE_PASSWORD: <password>
        XLD_TASK_QUEUE_URL: <queue-url>
        XLD_TASK_QUEUE_USERNAME: <username>
    - name: CrdName
      type: Select
      options:
        - !expr k8sResources(Namespace, 'crd')
      saveInXlvals: true
      promptIf: !expr "ProcessType == 'upgrade' && UpgradeType == 'operatorToOperator'"
      prompt: "Enter the name of custom resource definition:"
      ignoreIfSkipped: true
      overrideDefault: true
      description: The name of your custom resource definition.
      default: !expr "ProcessType == 'upgrade' && UpgradeType == 'operatorToOperator' ? k8sResource(Namespace, 'crd', ShortServerName) : ''"
    - name: CrName
      type: Select
      options:
        - !expr k8sResources(Namespace, CrdName)
      saveInXlvals: true
      promptIf: !expr "ProcessType == 'upgrade' && UpgradeType == 'operatorToOperator'"
      prompt: "Enter the name of custom resource:"
      ignoreIfSkipped: true
      overrideDefault: true
      description: The name of your custom resource
      default: !expr "ProcessType == 'upgrade' && UpgradeType == 'operatorToOperator' ? k8sResource(Namespace, CrdName, ShortServerName) : ''"
    - name: PreserveCrValuesDeploy
      type: Editor
      prompt: "Edit list of custom resource keys that will migrate to the new Deploy CR:"
      promptIf: !expr "ServerType == 'dai-deploy' && ProcessType == 'upgrade'"
      saveInXlvals: true
      ignoreIfSkipped: true
      description: "For all matched expressions in the cluster CR, the values will be migrated to the upgraded Deploy CR"
      default: |-
        .metadata.name
        .spec.XldMasterCount
        .spec.XldWorkerCount
        .spec.UseExistingDB.Enabled
        .spec.UseExistingMQ.Enabled
        .spec.ingress.hosts
        .spec.KeystorePassphrase
        .spec.Persistence.StorageClass
        .spec.Persistence.XldMasterPvcSize
        .spec.Persistence.XldWorkerPvcSize
        .spec.RepositoryKeystore
        .spec.postgresql.persistence.size
        .spec.postgresql.persistence.storageClass
        .spec.postgresql.postgresqlMaxConnections
        .spec.haproxy-ingress.install
        .spec.nginx-ingress-controller.install
        .spec.postgresql.install
        .spec.rabbitmq.install
        .spec.oidc
        .spec.keycloak.install
        .spec.keycloak.route
        .spec.keycloak.postgresql.persistence.size
        .spec.keycloak.postgresql.postgresqlMaxConnections
        .spec.keycloak.ingress.console.rules
        .spec.keycloak.ingress.rules
        .spec.rabbitmq.persistence.storageClass
        .spec.rabbitmq.persistence.size
        .spec.rabbitmq.replicaCount
        .spec.rabbitmq.persistence.replicaCount
        .spec.route.hosts
        .spec.xldLicense
        .spec.centralConfiguration.image.repository      
        .spec.centralConfiguration.persistence.pvcSize
        .spec.centralConfiguration.migrateFromEmbedded
        .spec.deploy.configurationManagement
    - name: PreserveCrValuesRelease
      type: Editor
      prompt: "Edit list of custom resource keys that will migrate to the new Release CR:"
      promptIf: !expr "ServerType == 'dai-release' && ProcessType == 'upgrade'"
      saveInXlvals: true
      ignoreIfSkipped: true
      description: For all matched expressions in the cluster CR, the values will be migrated to the upgraded Release CR
      default: |-
        .metadata.name
        .spec.replicaCount
        .spec.UseExistingDB.Enabled
        .spec.UseExistingMQ.Enabled
        .spec.ingress.hosts
        .spec.KeystorePassphrase
        .spec.Persistence.Size
        .spec.Persistence.StorageClass
        .spec.RepositoryKeystore
        .spec.postgresql.persistence.size
        .spec.postgresql.persistence.storageClass
        .spec.postgresql.postgresqlMaxConnections
        .spec.haproxy-ingress.install
        .spec.nginx-ingress-controller.install
        .spec.postgresql.install
        .spec.rabbitmq.install
        .spec.oidc
        .spec.keycloak.install
        .spec.keycloak.route
        .spec.keycloak.postgresql.persistence.size
        .spec.keycloak.postgresql.postgresqlMaxConnections
        .spec.keycloak.ingress.console.rules
        .spec.keycloak.ingress.rules
        .spec.rabbitmq.persistence.storageClass
        .spec.rabbitmq.persistence.size
        .spec.rabbitmq.replicaCount
        .spec.rabbitmq.persistence.replicaCount
        .spec.route.hosts
        .spec.xlrLicense
        .spec.release.configurationManagement
    - name: ReleaseName
      type: Input
      saveInXlvals: true
      promptIf: !expr UpgradeType == 'helmToOperator'
      prompt: "Enter the helm release name:"
      ignoreIfSkipped: true
      overrideDefault: true
      description: The name of your custom resource definition.
  files:
    # Generic
    - path: digitalai/generated_answers.yaml.tmpl
      renameTo: !expr "'digitalai/generated_answers_' + ServerType + '_' +  Namespace + '-' + GenerationDateTime + '.yaml.tmpl'"
    # Deploy
    - path: digitalai/dai-deploy/kubernetes-generic/template/cluster-role-digital-proxy-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-digital-proxy-role.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/cluster-role-manager-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-manager-role.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/cluster-role-metrics-reader.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-metrics-reader.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/controller-manager-metrics-service.yaml
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/controller-manager-metrics-service.yaml'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/custom-resource-definition.yaml
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/custom-resource-definition.yaml'"
    - path: digitalai/dai-deploy/kubernetes-generic/dai-deploy_cr_default.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/dai-deploy_cr_default.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/leader-election-role.yaml
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/leader-election-role.yaml'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/leader-election-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/leader-election-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/manager-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/manager-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/proxy-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/proxy-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/deployment.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/deployment.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/create-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && OidcConfigType == 'embedded' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/create-keycloak-db.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-generic/template/postgresql-init-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && OidcConfigType == 'embedded' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/postgresql-init-keycloak-db.yaml.tmpl'"
    # Deploy OpenShift
    - path: digitalai/dai-deploy/kubernetes-openshift/template/cluster-role-manager-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/cluster-role-manager-role.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-openshift/template/custom-resource-definition.yaml
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/custom-resource-definition.yaml'"
    - path: digitalai/dai-deploy/kubernetes-openshift/dai-deploy_cr_default.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/dai-deploy_cr_default.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-openshift/template/deployment.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/deployment.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-openshift/template/create-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && OidcConfigType == 'embedded' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/create-keycloak-db.yaml.tmpl'"
    - path: digitalai/dai-deploy/kubernetes-openshift/template/postgresql-init-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-deploy' && OidcConfigType == 'embedded' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-deploy/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/postgresql-init-keycloak-db.yaml.tmpl'"
    # Release
    - path: digitalai/dai-release/kubernetes-generic/template/cluster-role-digital-proxy-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-digital-proxy-role.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/cluster-role-manager-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-manager-role.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/cluster-role-metrics-reader.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/cluster-role-metrics-reader.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/controller-manager-metrics-service.yaml
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/controller-manager-metrics-service.yaml'"
    - path: digitalai/dai-release/kubernetes-generic/template/custom-resource-definition.yaml
      writeIf: !expr ServerType == 'dai-release' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/custom-resource-definition.yaml'"
    - path: digitalai/dai-release/kubernetes-generic/dai-release_cr_default.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/dai-release_cr_default.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/leader-election-role.yaml
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/leader-election-role.yaml'"
    - path: digitalai/dai-release/kubernetes-generic/template/leader-election-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/leader-election-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/manager-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/manager-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/proxy-rolebinding.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/proxy-rolebinding.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/deployment.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/deployment.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/create-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && OidcConfigType == 'embedded' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/create-keycloak-db.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-generic/template/postgresql-init-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && OidcConfigType == 'embedded' && K8sSetup != 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-generic/template/postgresql-init-keycloak-db.yaml.tmpl'"
    # Release OpenShift
    - path: digitalai/dai-release/kubernetes-openshift/template/cluster-role-manager-role.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/cluster-role-manager-role.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-openshift/template/custom-resource-definition.yaml
      writeIf: !expr ServerType == 'dai-release' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/custom-resource-definition.yaml'"
    - path: digitalai/dai-release/kubernetes-openshift/dai-release_cr_default.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/dai-release_cr_default.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-openshift/template/deployment.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/deployment.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-openshift/template/create-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && OidcConfigType == 'embedded' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/create-keycloak-db.yaml.tmpl'"
    - path: digitalai/dai-release/kubernetes-openshift/template/postgresql-init-keycloak-db.yaml.tmpl
      writeIf: !expr ServerType == 'dai-release' && OidcConfigType == 'embedded' && K8sSetup == 'Openshift'
      renameTo: !expr "'digitalai/dai-release/' + Namespace + '/' + GenerationDateTime + '/kubernetes-openshift/template/postgresql-init-keycloak-db.yaml.tmpl'"
